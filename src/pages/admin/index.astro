---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Panel de Administraci√≥n">
  <div class="min-h-screen bg-neutral-50 py-16 px-4">
    <div class="max-w-4xl mx-auto">
      <!-- Header -->
      <div class="mb-8">
        <a 
          href="/" 
          class="inline-flex items-center gap-2 text-neutral-600 hover:text-neutral-900 transition-colors mb-4"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
          <span class="font-sans text-sm">Inicio</span>
        </a>
        
        <h1 class="text-4xl font-light text-neutral-800 mb-2">Panel de Administraci√≥n</h1>
        <p class="text-neutral-500">Sube un nuevo poema para tu poemario</p>
      </div>
      
      <!-- Mensaje de estado -->
      <div id="status-message" class="hidden mb-6 p-4 rounded-lg"></div>
      
      <!-- Formulario -->
      <form id="poema-form" class="bg-white border border-neutral-200 rounded-xl p-8 shadow-sm">
        <!-- T√≠tulo -->
        <div class="mb-6">
          <label for="title" class="block text-sm font-medium text-neutral-700 mb-2">
            T√≠tulo del Poema *
          </label>
          <input
            type="text"
            id="title"
            name="title"
            required
            class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-rose-500 focus:border-transparent"
            placeholder="Ej: Primer Encuentro"
          />
        </div>
        
        <!-- Subt√≠tulo -->
        <div class="mb-6">
          <label for="subtitle" class="block text-sm font-medium text-neutral-700 mb-2">
            Subt√≠tulo (opcional)
          </label>
          <input
            type="text"
            id="subtitle"
            name="subtitle"
            class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-rose-500 focus:border-transparent"
            placeholder="Ej: El d√≠a que todo cambi√≥"
          />
        </div>
        
        <!-- Slug -->
        <div class="mb-6">
          <label for="slug" class="block text-sm font-medium text-neutral-700 mb-2">
            Slug (URL) *
          </label>
          <input
            type="text"
            id="slug"
            name="slug"
            required
            class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-rose-500 focus:border-transparent font-mono text-sm"
            placeholder="primer-encuentro"
          />
          <p class="text-xs text-neutral-500 mt-1">
            Solo letras min√∫sculas, n√∫meros y guiones. Ej: mi-poema-de-amor
          </p>
        </div>
        
        <!-- Categor√≠a -->
        <div class="mb-6">
          <label for="category" class="block text-sm font-medium text-neutral-700 mb-2">
            Categor√≠a *
          </label>
          <input
            type="text"
            id="category"
            name="category"
            required
            class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-rose-500 focus:border-transparent"
            placeholder="Ej: rom√°ntico, nost√°lgico, esperanza..."
          />
        </div>
        
        <!-- Tema -->
        <div class="mb-6">
          <label for="theme" class="block text-sm font-medium text-neutral-700 mb-2">
            Tema Visual *
          </label>
          <select
            id="theme"
            name="theme"
            required
            class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-rose-500 focus:border-transparent"
          >
            <option value="">Selecciona un tema...</option>
            <option value="rom√°ntico">üåπ Rom√°ntico (Rosa/Pink)</option>
            <option value="cottage-core">üåø Cottage Core (Verde/Natural)</option>
            <option value="sereno">üåä Sereno (Azul/Calma)</option>
            <option value="nost√°lgico">üçÇ Nost√°lgico (√Åmbar/Vintage)</option>
          </select>
        </div>
        
        <!-- Fecha de publicaci√≥n -->
        <div class="mb-6">
          <label for="published_date" class="block text-sm font-medium text-neutral-700 mb-2">
            Fecha de Publicaci√≥n *
          </label>
          <input
            type="date"
            id="published_date"
            name="published_date"
            required
            class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-rose-500 focus:border-transparent"
          />
        </div>
        
        <!-- Contenido -->
        <div class="mb-8">
          <label for="content" class="block text-sm font-medium text-neutral-700 mb-2">
            Contenido del Poema *
          </label>
          <textarea
            id="content"
            name="content"
            required
            rows="15"
            class="w-full px-4 py-3 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-rose-500 focus:border-transparent font-serif text-lg leading-relaxed"
            placeholder="Escribe tu poema aqu√≠...

Cada l√≠nea en blanco crear√° un espacio.
Los versos se mostrar√°n centrados."
          ></textarea>
          <p class="text-xs text-neutral-500 mt-1">
            Escribe el poema como quieras que se vea. Las l√≠neas vac√≠as crear√°n espacios.
          </p>
        </div>
        
        <!-- Botones -->
        <div class="flex gap-4">
          <button
            type="submit"
            class="flex-1 bg-rose-600 text-white px-6 py-3 rounded-lg hover:bg-rose-700 transition-colors font-sans"
          >
            Publicar Poema
          </button>
          <button
            type="button"
            id="preview-button"
            class="px-6 py-3 border border-neutral-300 rounded-lg hover:bg-neutral-50 transition-colors font-sans"
          >
            Vista Previa
          </button>
        </div>
      </form>
      
      <!-- Preview Modal -->
      <div id="preview-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto p-8">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-light text-neutral-800">Vista Previa</h2>
            <button id="close-preview" class="text-neutral-500 hover:text-neutral-700">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          <div id="preview-content" class="prose prose-lg mx-auto"></div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { supabase } from '../../lib/supabase';
  
  const form = document.getElementById('poema-form') as HTMLFormElement;
  const statusMessage = document.getElementById('status-message');
  const previewButton = document.getElementById('preview-button');
  const previewModal = document.getElementById('preview-modal');
  const closePreview = document.getElementById('close-preview');
  const previewContent = document.getElementById('preview-content');
  const publishedDateInput = document.getElementById('published_date') as HTMLInputElement;
  
  // Establecer fecha de hoy por defecto
  if (publishedDateInput) {
    publishedDateInput.valueAsDate = new Date();
  }
  
  // Auto-generar slug desde el t√≠tulo
  const titleInput = document.getElementById('title') as HTMLInputElement;
  const slugInput = document.getElementById('slug') as HTMLInputElement;
  
  if (titleInput && slugInput) {
    titleInput.addEventListener('input', () => {
      const slug = titleInput.value
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
      slugInput.value = slug;
    });
  }
  
  // Mostrar preview
  if (previewButton && previewModal && closePreview && previewContent) {
    previewButton.addEventListener('click', () => {
      const title = (document.getElementById('title') as HTMLInputElement).value;
      const subtitle = (document.getElementById('subtitle') as HTMLInputElement).value;
      const content = (document.getElementById('content') as HTMLTextAreaElement).value;
      
      const lines = content.split('\n').map(line => 
        line.trim() === '' 
          ? '<p class="h-4"></p>' 
          : `<p class="text-center">${line}</p>`
      ).join('');
      
      previewContent.innerHTML = `
        <h1 class="text-4xl font-light text-center mb-4">${title}</h1>
        ${subtitle ? `<p class="text-center italic text-rose-600 mb-8">${subtitle}</p>` : ''}
        <div class="w-24 h-px bg-neutral-300 mx-auto mb-8"></div>
        ${lines}
      `;
      
      previewModal.classList.remove('hidden');
    });
    
    closePreview.addEventListener('click', () => {
      previewModal.classList.add('hidden');
    });
  }
  
  // Enviar formulario
  if (form && statusMessage) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(form);
      const poema = {
        title: formData.get('title') as string,
        subtitle: formData.get('subtitle') as string || null,
        slug: formData.get('slug') as string,
        category: formData.get('category') as string,
        theme: formData.get('theme') as string,
        content: formData.get('content') as string,
        published_date: formData.get('published_date') as string,
      };
      
      try {
        const { data, error } = await supabase
          .from('poemas')
          .insert(poema)
          .select()
          .single();
        
        if (error) throw error;
        
        statusMessage.textContent = '‚úÖ ¬°Poema publicado exitosamente!';
        statusMessage.className = 'mb-6 p-4 rounded-lg bg-green-50 text-green-800 border border-green-200';
        statusMessage.classList.remove('hidden');
        
        form.reset();
        if (publishedDateInput) {
          publishedDateInput.valueAsDate = new Date();
        }
        
        setTimeout(() => {
          window.location.href = `/poemas/${data.slug}`;
        }, 1500);
        
      } catch (error: any) {
        statusMessage.textContent = `‚ùå Error: ${error.message}`;
        statusMessage.className = 'mb-6 p-4 rounded-lg bg-red-50 text-red-800 border border-red-200';
        statusMessage.classList.remove('hidden');
      }
    });
  }
</script>