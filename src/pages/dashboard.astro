---
import Layout from '../layouts/Layout.astro';
import { getPoemas, supabase } from '../lib/supabase';

const poemas = await getPoemas();

// Obtener todos los likes con información del poema
const { data: likes } = await supabase
  .from('likes')
  .select(`
    id,
    liked_at,
    poema_id,
    poemas (
      title,
      slug,
      published_date,
      category
    )
  `)
  .order('liked_at', { ascending: false });

const totalPoemas = poemas.length;
const totalLikes = likes?.length || 0;
const poemasConLike = new Set(likes?.map(l => l.poema_id) || []).size;
---

<Layout title="Dashboard">
  <div class="min-h-screen bg-neutral-50 py-16 px-4">
    <div class="max-w-6xl mx-auto">
      <!-- Header -->
      <div class="mb-8">
        <a 
          href="/" 
          class="inline-flex items-center gap-2 text-neutral-600 hover:text-neutral-900 transition-colors mb-4"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
          <span class="font-sans text-sm">Inicio</span>
        </a>
        
        <div class="flex justify-between items-start">
          <div>
            <h1 class="text-4xl font-light text-neutral-800 mb-2">Dashboard</h1>
            <p class="text-neutral-500">Estadísticas de tu poemario</p>
          </div>
          <div class="flex gap-3">
            <a 
              href="/stats" 
              class="px-4 py-2 border-2 border-neutral-300 text-neutral-700 rounded-lg hover:bg-neutral-50 transition-colors font-sans text-sm"
            >
              Ver Más
            </a>
            <a 
              href="/admin" 
              class="px-4 py-2 bg-rose-600 text-white rounded-lg hover:bg-rose-700 transition-colors font-sans text-sm"
            >
              + Nuevo Poema
            </a>
          </div>
        </div>
      </div>
      
      <!-- Estadísticas -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
        <!-- Total de poemas -->
        <div class="bg-white border border-neutral-200 rounded-xl p-6 shadow-sm">
          <div class="flex items-center gap-3 mb-2">
            <svg class="w-8 h-8 text-rose-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
            </svg>
            <h3 class="text-sm font-medium text-neutral-600 font-sans">Total Poemas</h3>
          </div>
          <p class="text-3xl font-light text-neutral-800">{totalPoemas}</p>
        </div>
        
        <!-- Poemas con like -->
        <div class="bg-white border border-neutral-200 rounded-xl p-6 shadow-sm">
          <div class="flex items-center gap-3 mb-2">
            <svg class="w-8 h-8 text-rose-500" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
            </svg>
            <h3 class="text-sm font-medium text-neutral-600 font-sans">Con Like</h3>
          </div>
          <p class="text-3xl font-light text-neutral-800">{poemasConLike}</p>
          <p class="text-xs text-neutral-400 mt-1">
            {totalPoemas > 0 ? Math.round((poemasConLike / totalPoemas) * 100) : 0}% del total
          </p>
        </div>
        
        <!-- Total de likes -->
        <div class="bg-white border border-neutral-200 rounded-xl p-6 shadow-sm">
          <div class="flex items-center gap-3 mb-2">
            <svg class="w-8 h-8 text-rose-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
            <h3 class="text-sm font-medium text-neutral-600 font-sans">Total Likes</h3>
          </div>
          <p class="text-3xl font-light text-neutral-800">{totalLikes}</p>
        </div>
      </div>
      
      <!-- Sección de likes recientes -->
      {likes && likes.length > 0 && (
        <div class="bg-white border border-neutral-200 rounded-xl p-8 shadow-sm mb-12">
          <h2 class="text-2xl font-light text-neutral-800 mb-6">Poemas que le gustaron ❤️</h2>
          <div class="space-y-4">
            {likes.map((like: any) => (
              <a 
                href={`/poemas/${like.poemas.slug}`}
                class="block p-4 border border-neutral-200 rounded-lg hover:border-rose-300 hover:bg-rose-50/30 transition-all group"
              >
                <div class="flex items-start justify-between gap-4">
                  <div class="flex-1">
                    <h3 class="text-lg font-medium text-neutral-800 group-hover:text-rose-600 transition-colors mb-1">
                      {like.poemas.title}
                    </h3>
                    <div class="flex items-center gap-3 text-sm text-neutral-500">
                      <span class="capitalize">{like.poemas.category}</span>
                      <span>•</span>
                      <time>
                        Le gustó el {new Date(like.liked_at).toLocaleDateString('es-ES', { 
                          year: 'numeric', 
                          month: 'long', 
                          day: 'numeric',
                          hour: '2-digit',
                          minute: '2-digit'
                        })}
                      </time>
                    </div>
                  </div>
                  <svg class="w-6 h-6 text-rose-500 flex-shrink-0 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                  </svg>
                </div>
              </a>
            ))}
          </div>
        </div>
      )}
      
      <!-- Todos los poemas -->
      <div class="bg-white border border-neutral-200 rounded-xl p-8 shadow-sm">
        <h2 class="text-2xl font-light text-neutral-800 mb-6">Todos los Poemas</h2>
        {poemas.length === 0 ? (
          <p class="text-neutral-400 italic text-center py-8">No hay poemas publicados aún</p>
        ) : (
          <div class="space-y-3">
            {poemas.map((poema) => {
              const tienelike = likes?.some((l: any) => l.poema_id === poema.id);
              return (
                <a 
                  href={`/poemas/${poema.slug}`}
                  class="block p-4 border border-neutral-200 rounded-lg hover:border-neutral-300 hover:bg-neutral-50 transition-all group"
                >
                  <div class="flex items-center justify-between gap-4">
                    <div class="flex-1">
                      <h3 class="text-lg font-medium text-neutral-800 mb-1">
                        {poema.title}
                      </h3>
                      <div class="flex items-center gap-3 text-sm text-neutral-500">
                        <span class="capitalize">{poema.category}</span>
                        <span>•</span>
                        <time>
                          {new Date(poema.published_date).toLocaleDateString('es-ES', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                          })}
                        </time>
                      </div>
                    </div>
                    <div class="flex items-center gap-3">
                      {tienelike ? (
                        <span class="flex items-center gap-1 text-rose-500 text-sm font-sans">
                          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                          </svg>
                          Le gustó
                        </span>
                      ) : (
                        <span class="text-neutral-300 text-sm font-sans">Sin like</span>
                      )}
                      <svg class="w-5 h-5 text-neutral-300 group-hover:text-neutral-600 group-hover:translate-x-1 transition-all" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                      </svg>
                    </div>
                  </div>
                </a>
              );
            })}
          </div>
        )}
      </div>
    </div>
  </div>
</Layout>