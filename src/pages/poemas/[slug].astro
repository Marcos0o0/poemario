---
// src/pages/poemas/[slug].astro
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../lib/supabase';
import RomanticoTheme from '../../components/themes/RomanticoTheme.astro';
import CottageCoreTheme from '../../components/themes/CottageCoreTheme.astro';
import SerenoTheme from '../../components/themes/SerenoTheme.astro';
import NostalgicoTheme from '../../components/themes/NostalgicoTheme.astro';

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/poemas');
}

// Obtener el poema
const { data: poema, error: poemaError } = await supabase
  .from('poemas')
  .select('*')
  .eq('slug', slug)
  .single();

if (poemaError || !poema) {
  return Astro.redirect('/poemas');
}

// Obtener like
const { data: like } = await supabase
  .from('likes')
  .select('*')
  .eq('poema_id', poema.id)
  .maybeSingle();

const hasLike = !!like;

// Obtener comentarios
const { data: comments } = await supabase
  .from('comments')
  .select('*')
  .eq('poema_id', poema.id)
  .order('created_at', { ascending: false });

// Seleccionar el tema correcto
const themes: Record<string, any> = {
  'romántico': RomanticoTheme,
  'cottage-core': CottageCoreTheme,
  'sereno': SerenoTheme,
  'nostálgico': NostalgicoTheme,
};

const ThemeComponent = themes[poema.theme] || RomanticoTheme;
---

<Layout title={poema.title} description={poema.subtitle}>
  <ThemeComponent 
    title={poema.title}
    subtitle={poema.subtitle}
    content={poema.content}
    poemaId={poema.id}
    hasLike={hasLike}
    category={poema.category}
    publishedDate={poema.published_date}
    comments={comments || []}
  />
</Layout>