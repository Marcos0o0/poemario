---
interface Props {
  poemaId: string;
  comments: Array<{
    id: string;
    content: string;
    created_at: string;
  }>;
  themeColor?: 'rose' | 'emerald' | 'sky' | 'amber';
}

const { poemaId, comments, themeColor = 'rose' } = Astro.props;

const colorClasses = {
  rose: {
    border: 'border-rose-300',
    bg: 'bg-rose-50',
    text: 'text-rose-600',
    button: 'bg-rose-600 hover:bg-rose-700',
    focus: 'focus:ring-rose-500'
  },
  emerald: {
    border: 'border-emerald-300',
    bg: 'bg-emerald-50',
    text: 'text-emerald-600',
    button: 'bg-emerald-600 hover:bg-emerald-700',
    focus: 'focus:ring-emerald-500'
  },
  sky: {
    border: 'border-sky-300',
    bg: 'bg-sky-50',
    text: 'text-sky-600',
    button: 'bg-sky-600 hover:bg-sky-700',
    focus: 'focus:ring-sky-500'
  },
  amber: {
    border: 'border-amber-300',
    bg: 'bg-amber-50',
    text: 'text-amber-600',
    button: 'bg-amber-600 hover:bg-amber-700',
    focus: 'focus:ring-amber-500'
  }
};

const colors = colorClasses[themeColor];
---

<div class="mt-16 relative z-10">
  <!-- Separador decorativo -->
  <div class="flex items-center justify-center gap-3 mb-8">
    <div class={`w-12 h-px ${colors.border}`}></div>
    <svg class={`w-5 h-5 ${colors.text}`} fill="currentColor" viewBox="0 0 24 24">
      <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z"/>
    </svg>
    <div class={`w-12 h-px ${colors.border}`}></div>
  </div>

  <h3 class="text-2xl font-light text-neutral-800 text-center mb-2">
    Comentarios
  </h3>
  <p class="text-center text-neutral-500 italic text-sm mb-8">
    Déjame saber qué te pareció este poema
  </p>

  <!-- Formulario de comentario -->
  <div class={`${colors.bg} border-2 ${colors.border} rounded-xl p-6 mb-8`}>
    <form id="comment-form" data-poema-id={poemaId}>
      <textarea
        id="comment-input"
        name="content"
        required
        rows="4"
        placeholder="Escribe tu comentario aquí..."
        class={`w-full px-4 py-3 border-2 ${colors.border} rounded-lg focus:ring-2 ${colors.focus} focus:border-transparent resize-none font-sans text-base`}
      ></textarea>
      
      <div class="flex items-center justify-between mt-4">
        <p class="text-xs text-neutral-500 italic">
          Te amo mucho mi vida
        </p>
        <button
          type="submit"
          class={`px-6 py-2 ${colors.button} text-white rounded-lg transition-colors font-sans text-sm flex items-center gap-2`}
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
          </svg>
          Enviar
        </button>
      </div>
    </form>
  </div>

  <!-- Lista de comentarios -->
  <div id="comments-list" class="space-y-4">
    {comments.length === 0 ? (
      <div class="text-center py-8">
        <svg class="w-12 h-12 mx-auto text-neutral-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
        </svg>
        <p class="text-neutral-400 italic text-sm">
          Aún no hay comentarios.
        </p>
      </div>
    ) : (
      comments.map((comment) => (
        <div class="bg-white border-2 border-neutral-200 rounded-lg p-5 hover:border-neutral-300 transition-colors comment-item" data-comment-id={comment.id}>
          <div class="flex items-start justify-between gap-3 mb-3">
            <div class="flex items-center gap-2">
              <div class={`w-8 h-8 rounded-full ${colors.bg} flex items-center justify-center`}>
                <svg class={`w-4 h-4 ${colors.text}`} fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                </svg>
              </div>
              <span class="font-sans text-sm font-medium text-neutral-700">Mi amor</span>
            </div>
            <time class="text-xs text-neutral-400 font-sans">
              {new Date(comment.created_at).toLocaleDateString('es-ES', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              })}
            </time>
          </div>
          <p class="text-neutral-700 leading-relaxed whitespace-pre-wrap">
            {comment.content}
          </p>
          
          <!-- Botón de eliminar (opcional) -->
          <button 
            class="delete-comment mt-3 text-xs text-neutral-400 hover:text-red-600 transition-colors font-sans"
            data-comment-id={comment.id}
          >
            Eliminar
          </button>
        </div>
      ))
    )}
  </div>

  <!-- Mensaje de estado -->
  <div id="comment-status" class="hidden mt-4 p-3 rounded-lg text-sm font-sans"></div>
</div>

<script>
  import { supabase } from '../lib/supabase';

  const form = document.getElementById('comment-form') as HTMLFormElement;
  const input = document.getElementById('comment-input') as HTMLTextAreaElement;
  const commentsList = document.getElementById('comments-list');
  const statusMessage = document.getElementById('comment-status');

  // Función para mostrar mensajes de estado
  function showStatus(message: string, type: 'success' | 'error') {
    if (!statusMessage) return;
    
    statusMessage.textContent = message;
    statusMessage.className = `mt-4 p-3 rounded-lg text-sm font-sans ${
      type === 'success' 
        ? 'bg-green-50 text-green-800 border border-green-200' 
        : 'bg-red-50 text-red-800 border border-red-200'
    }`;
    statusMessage.classList.remove('hidden');
    
    setTimeout(() => {
      statusMessage.classList.add('hidden');
    }, 3000);
  }

  // Enviar comentario
  if (form && input) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const content = input.value.trim();
      const poemaId = form.dataset.poemaId;
      
      if (!content || !poemaId) return;
      
      try {
        const { data, error } = await supabase
          .from('comments')
          .insert({ poema_id: poemaId, content })
          .select()
          .single();
        
        if (error) throw error;
        
        // Limpiar input
        input.value = '';
        
        // Recargar la página para mostrar el nuevo comentario
        window.location.reload();
        
      } catch (error: any) {
        showStatus(`Error al enviar comentario: ${error.message}`, 'error');
      }
    });
  }

  // Eliminar comentarios
  document.querySelectorAll('.delete-comment').forEach(button => {
    button.addEventListener('click', async (e) => {
      const commentId = (e.target as HTMLElement).dataset.commentId;
      
      if (!commentId || !confirm('¿Estás segura de que quieres eliminar este comentario?')) return;
      
      try {
        const { error } = await supabase
          .from('comments')
          .delete()
          .eq('id', commentId);
        
        if (error) throw error;
        
        // Eliminar visualmente el comentario
        const commentItem = document.querySelector(`[data-comment-id="${commentId}"]`);
        if (commentItem) {
          commentItem.remove();
        }
        
        showStatus('Comentario eliminado', 'success');
        
        // Si no quedan comentarios, recargar para mostrar el mensaje de "no hay comentarios"
        const remainingComments = document.querySelectorAll('.comment-item');
        if (remainingComments.length === 0) {
          window.location.reload();
        }
        
      } catch (error: any) {
        showStatus(`Error al eliminar: ${error.message}`, 'error');
      }
    });
  });
</script>